{% extends "settings/base.html" %}

{% block title %}Settings - Fleet Settings{% endblock %}

{% block head %}
{{ super() }}
<meta name="api-fleet-remove" content="{{url_for('api_fleet.removeFleet', fleetID=-1)}}"/>
<script src="{{url_for('static', filename='js/typeahead.bundle.min'+version+'.js')}}" type="text/javascript"></script>
<script src="{{url_for('static', filename='js/fleet-settings'+version+'.js')}}" type="text/javascript"></script>
<link rel="stylesheet" href="{{url_for('static', filename='css/typeaheadjs'+version+'.css')}}">
<link rel="stylesheet" href="{{url_for('static', filename='css/settings-fleet'+version+'.css')}}">
<script type="text/javascript">
$(document).ready(function(){
	var constellationSource = new Bloodhound({
		datumTokenizer: Bloodhound.tokenizers.obj.whitespace('conName'),
		queryTokenizer: Bloodhound.tokenizers.whitespace,
		remote: {
			url: "{{url_for('settings.fleet_query_constellations')}}?term=%QUERY",
			wildcard: '%QUERY',
			filter: function(response) {
	            return response.result;
	        }
		}
	});
	$('.con-typeahead').typeahead({
		  hint: true,
		  highlight: true,
		  minLength: 1
		}, {
		name: 'constellations',
		display: 'conName',
		source: constellationSource
	});
	
	var stationSource = new Bloodhound({
		datumTokenizer: Bloodhound.tokenizers.obj.whitespace('statName'),
		queryTokenizer: Bloodhound.tokenizers.whitespace,
		remote: {
			url: "{{url_for('settings.fleet_query_stations')}}?term=%QUERY",
			wildcard: '%QUERY',
			filter: function(response) {
	            return response.result;
	        }
		}
	});
	$('.dock-typeahead').typeahead({
		  hint: true,
		  highlight: true,
		  minLength: 1
		}, {
		name: 'stations',
		display: 'statName',
		source: stationSource
	});

	var systemSource = new Bloodhound({
		datumTokenizer: Bloodhound.tokenizers.obj.whitespace('sysName'),
		queryTokenizer: Bloodhound.tokenizers.whitespace,
		remote: {
			url: "{{url_for('settings.fleet_query_systems')}}?term=%QUERY",
			wildcard: '%QUERY',
			filter: function(response) {
	            return response.result;
	        }
		}
	});
	$('.hq-typeahead').typeahead({
		  hint: true,
		  highlight: true,
		  minLength: 1
		}, {
		name: 'SolarSystems',
		display: 'sysName',
		source: systemSource
	});
});

function clearWaitlist(gid) {
	$('#clearwaitlistform-'+gid).submit();
}

$(document).ready(function() {
	$("#remove-diag").on('show.bs.modal', function(e){
		var source = $(e.relatedTarget);
		var fname = source.data("type")
		var gid = Number(source.data("id"))
		if (fname == "clearWaitlist") {
			$("#remove-diag-accept").off();
			$("#remove-diag-accept").on("click", function() {
				window[fname](gid);
			});
			
			$("#remove-diag-body").text("Do your really want to clear the Waitlist and all Xups?");
			$("#remove-diag-label").text("Clear Waitlist???");
		}
	});
});
</script>
{% endblock %}

{% block content %}
{% for group in groups %}
<form id="clearwaitlistform-{{group.groupID}}" action="{{url_for('settings.clear_waitlist', gid=group.groupID)}}" method="post" class="form-inline hidden">
<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
</form>
<button data-toggle="modal" data-target="#remove-diag" data-type="clearWaitlist" class="btn btn-sm btn-danger" data-id="{{group.groupID}}">Clear Waitlists!</button>
<div class="card">
  <div class="card-block"> 
    <table class="table table-sm">
    <tbody>
    <tr>
    <th scope="row">Display Name</th>
    <td colspan="2">{{group.displayName}}</td>
    </tr>
    <tr>
    	<th scope="row">Status</th>
    	<td colspan="2">
    	<form action="{{url_for('settings.fleet_status_set', gid=group.groupID)}}" method="post" class="form-inline">
    		<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    		<input type="hidden" name="action" value="status">
    		{% if perm_officer.can() or perm_leadership.can() %}
    		<input type="text" name="status" value="{{group.status}}" class="form-control form-control-sm">
    		{% else %}
    		<select class="form-control form-control-sm c-select" id="status-{{group.groupID}}" name="status" required>
				<option value="">Please Select</option>
				<option value="Down"{% if group.status == "Down" %} selected{% endif %}>Down</option>
				<option value="Forming"{% if group.status == "Forming" %} selected{% endif %}>Forming</option>
				<option value="Running"{% if group.status == "Running" %} selected{% endif %}>Running</option>
			</select>
    		{% endif %}
    		<label><input class="form-control form-control-sm" name="xup" type="checkbox" {% if group.enabled %}checked{% endif %}> X-UP Open</label>
    		<label><input class="form-control form-control-sm" name="influence" type="checkbox" {% if group.influence %}checked{% endif %}> Influence</label>
    		<button type="submit" class="btn btn-sm btn-primary">Set</button>
    	</form>
    	</td>
    </tr>
    <tr>
    	<th scope="row">FC</th>
    	<td>
    	{% for fc in group.fcs %}
    	<a href="javascript:CCPEVE.showInfo(1377, {{fc.get_eve_id()}});">{{fc.get_eve_name()}}</a>
    	<form action="{{url_for('settings.fleet_status_set', gid=group.groupID)}}" method="post" class="form-inline" style="display:inline;">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="fc-remove">
    	<input type="hidden" name="accountID" value="{{fc.id}}">
    	<button type="submit" class="btn btn-mini btn-danger"><i class="fa fa-times" aria-hidden="true"></i></button>
    	</form>
    	{% endfor %}
    	</td>
    	<td>
    	<form action="{{url_for('settings.fleet_status_set', gid=group.groupID)}}" method="post" class="form-inline">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="fc">
    	<button type="submit" class="btn btn-sm btn-primary">Add Self</button>
    	</form>
    	</td>
    </tr>
    <tr>
    	<th scope="row">Fleet Manager</th>
    	<td>
    	{% for manager in group.manager %}
    	<a href="javascript:CCPEVE.showInfo(1377, {{manager.get_eve_id()}});">{{manager.get_eve_name()}}</a>
    	<form action="{{url_for('settings.fleet_status_set', gid=group.groupID)}}" method="post" class="form-inline" style="display:inline;">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="manager-remove">
    	<input type="hidden" name="accountID" value="{{manager.id}}">
    	<button type="submit" class="btn btn-mini btn-danger"><i class="fa fa-times" aria-hidden="true"></i></button>
    	</form>
    	{% endfor %}
    	</td>
    	<td>
    	<form action="{{url_for('settings.fleet_status_set', gid=group.groupID)}}" method="post" class="form-inline">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="manager">
    	<!-- <input type="text" name="name" value="{{user.get_eve_name()}}"> -->
    	<button type="submit" class="btn btn-sm btn-primary">Add Self</button>
    	</form>
    	</td>
    </tr>
    {% if perm_officer.can() or perm_leadership.can() %}
    <tr>
    	<th scope="row">Constellation</th>
    	<td>{% if group.constellation is not none %}<a href="javascript:CCPEVE.showInfo(4, {{group.constellation.constellationID}});">{{group.constellation.constellationName}}</a>{% else %}Not Set{% endif %}</td>
    	<td>
    	<form action="{{url_for('settings.fleet_location_set', gid=group.groupID)}}" method="post" class="form-inline">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="constellation">
    	<input id="con-typeahead-{{group.groupID}}" class="form-control form-control-sm typeahead con-typeahead" type="text" name="name">
    	<button type="submit" class="btn btn-sm btn-primary">Set</button>
    	</form>
    	</td>
    </tr>
    <tr>
    	<th scope="row">Dockup</th>
    	<td>{% if group.dockup is not none %}<a href="javascript:CCPEVE.setDestination({{group.dockup.stationID}});">{{group.dockup.stationName}}</a>{% else %}Not Set{% endif %}</td>
    	<td>
    	<form action="{{url_for('settings.fleet_location_set', gid=group.groupID)}}" method="post" class="form-inline">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="dock">
    	<input id="dock-typeahead-{{group.groupID}}" class="form-control form-control-sm typeahead dock-typeahead" type="text" name="name">
    	<button type="submit" class="btn btn-sm btn-primary">Set</button>
    	</form>
    	</td>
    </tr>
    <tr>
    	<th scope="row">System</th>
    	<td>{% if group.system is not none %}<a href="javascript:CCPEVE.showInfo(5, {{group.system.solarSystemID}});">{{group.system.solarSystemName}}</a>{% else %}Not Set{% endif %}</td>
    	<td>
    	<form action="{{url_for('settings.fleet_location_set', gid=group.groupID)}}" method="post" class="form-inline">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="system">
    	<input id="hq-typeahead-{{group.groupID}}" class="form-control form-control-sm typeahead hq-typeahead" type="text" name="name">
    	<button type="submit" class="btn btn-sm btn-primary">Set</button>
    	</form>
    	</td>
    </tr>
    {% endif %}
    <tr>
    <th scope="row">Backseats:</th>
    <td colspan="2">
    {% for backseat in group.backseats %}
    	<a href="javascript:IGBW.showInfo(1377, {{backseat.current_char_obj.get_eve_id()}});">{{backseat.current_char_obj.get_eve_name()}}</a>
    	<form action="{{url_for('settings.fleet_status_set', gid=group.groupID)}}" method="post" class="form-inline" style="display:inline;">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="remove-backseat">
    	<input type="hidden" name="accountID" value="{{backseat.id}}">
    	<button type="submit" class="btn btn-mini btn-danger"><i class="fa fa-times" aria-hidden="true"></i></button>
    	</form>
		{% if not loop.last %} - {% endif %}
    {% endfor %}
    	<form action="{{url_for('settings.fleet_status_set', gid=group.groupID)}}" method="post" class="form-inline" style="display:inline;">
    	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    	<input type="hidden" name="action" value="add-backseat">
    	<button type="submit" class="btn btn-sm btn-primary">Add Self</button>
    	</form>
    </td>
    </tr>
    <tr>
    	<th scope="row">Register for Fleet</th>
    	<td colspan="2">
			<form>
			<a href="{{url_for('fleet.take_form')}}" class="btn btn-sm btn-primary">Take over a Fleet</a>
			</form>
    	</td>
    </tr>
    <tr>
    <th>Fleet ID</th><th>Current Fleet Comp</th><th>Actions</th>
    </tr>
    {% for fleet in group.fleets %}
    <tr id="fleet-{{fleet.fleetID}}">
        <td>{{fleet.fleetID}}</td>
        <td>{% if fleet.comp %}<a href="javascript:IGBW.showInfo(1377, {{fleet.comp.get_eve_id()}});">{{fleet.comp.username}}</a>{% else %}{{None}}{% endif %}</td>
        <td>
        	<button class="btn btn-danger btn-sm" data-type="remove-fleet" data-id="{{fleet.fleetID}}">Remove</button>
        	<a href="{{url_for('fleet.change_type', fleetID=fleet.fleetID)}}" class="btn btn-sm btn-warning">Change Fleet Type</a>
        </td>
    </tr>
    {% endfor %}
    </tbody>
    </table>
  </div>
</div>
{% endfor %}
<div class="modal fade bd-example-modal-sm" id="remove-diag" tabindex="-1" role="dialog" aria-labelledby="remove-diag-label" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
      	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
      		<span aria-hidden="true">&times;</span>
		</button>
        <h4 class="modal-title" id="remove-diag-label"></h4>
      </div>
      <div class="modal-body" id="remove-diag-body">
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-success" data-dismiss="modal">No</button>
          <button type="button" class="btn btn-danger" id="remove-diag-accept">Yes</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
